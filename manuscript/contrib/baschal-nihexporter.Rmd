---
title: "nihexporter"
author: "Erin Baschal"
date: "3/10/2015"
output: html_document
---

Calculate P01 vs R01 by number of PIs (so cost per PI-because P01 have multiple PIs)


```{r libraries, message=FALSE, warning=FALSE}
# Load Libraries
library(dplyr)
library(nihexporter)
library(ggplot2)
library(knitr)
```


Calculate grant productivity (and cost) per PI

```{r CostPerPubPerPI}

num_PI.df <- projects %>%
  filter(institute %in% nih.institutes) %>%
  filter(project.num != '') %>%
  na.omit(total.cost) %>%
  left_join(project_pis) %>%
  group_by(project.num, study.section, activity) %>%
  summarise(n.PI = n(), grant.cost = sum(total.cost), 
            duration = (max(project.end) - min(project.start))) %>%
  mutate(cost.per.pi = (grant.cost / n.PI))

grant_pubs.df <- projects %>%
  select(project.num) %>%
  left_join(publinks) %>%
  group_by(project.num) %>%
  summarise(n.pub = n())

PI_pub_proj.df <- num_PI.df %>%
  left_join(grant_pubs.df) %>%
  ungroup() %>%
  mutate(PI.type = ifelse(n.PI == 1, 'one_PI', 'multiple_PI')) %>%
  mutate(cost.per.pub = grant.cost / n.pub) %>%
  mutate(PI.cost.per.pub = cost.per.pub / n.PI)
```

```{r activity}
PI_activity_list <- PI_pub_proj.df %>%
  select(activity) %>%
  group_by(activity) %>%
  summarise(activity.count = n())

# this is still ugly but at least it skips creating multiple data frames
PI_activity.df <- PI_pub_proj.df %>%
  mutate(activity.type = ifelse(grepl('^R', activity), 'R', 
                                ifelse(grepl('^F', activity), 'F', 
                                       ifelse(grepl('^P', activity), 'P', 
                                              ifelse(grepl('U', activity), 'U', 
                                                     ifelse(grepl('^K', activity), 'K', 
                                                            ifelse(grepl('^T', activity), 'T',
                                                                   'Other'))))))) %>%
  select(project.num, activity.type)
   
PI_act_pub_proj.df  <- PI_pub_proj.df %>%
  left_join(PI_activity.df)

# remove "other" activity types (not R, F, P, U, K, or T)
PI_act_remove_pub_proj.df  <- PI_act_pub_proj.df %>%
  filter(activity.type != 'Other')
```

```{r plots}
# cost per publication per PI
# plot without "other" activity types
# include outliers
PI_act_remove_pub_proj.df %>%
  ggplot(aes(x = activity.type, y = PI.cost.per.pub/1e6, fill = PI.type)) +
  geom_boxplot() +
  theme_bw() +
  ylim(0,3) +
  xlab('Activity Type') +
  ylab('Cost Per Publication Per PI (in Millions)') +
  ggtitle('Cost Per Publication Per PI for Activity Types (F, K, P, R, T, U)')

# cost per publication
# plot without "other" activity types
# include outliers
PI_act_remove_pub_proj.df %>%
  ggplot(aes(x = activity.type, y = cost.per.pub/1e6, fill = PI.type)) +
  geom_boxplot() +
  theme_bw() +
  ylim(0,3) +
  xlab('Activity Type') +
  ylab('Cost Per Publication (in Millions)') +
  ggtitle('Cost Per Publication for Activity Types (F, K, P, R, T, U)')
```

```{r summarize_results}
summary_act.df <- PI_act_remove_pub_proj.df %>%
  group_by(activity.type, PI.type) %>%
  summarize(median.cost.per.pub.PI = round(median(PI.cost.per.pub), digits = 0), 
            mean.cost.per.pub.PI = round(mean(PI.cost.per.pub), digits = 0))

kable(summary_act.df, caption = "Cost Per Publication Per PI, Multiple PI vs Single PI Grants, by Activity")


```

F=Fellowship Programs, K= Research Career Programs, P=Research Program Projects and Centers, R=Research Projects, T=Training Programs, U=Cooperative Agreements.  Removed "Other" which includes N01, which had very large spending amounts.  These 

Interpretation: It appears that having more than 1 PI on a grant increases your "productivity" when productivity is measured as cost per publication per PI.


Better question might be if multiple PI grants have a higher or lower cost per publication (regardless of number of PIs) than single PI grants

```{r multPI}
summary_mult_act.df <- PI_act_remove_pub_proj.df %>%
  group_by(activity.type, PI.type) %>%
  summarize(median.cost.per.pub = round(median(cost.per.pub), digits = 0), 
            mean.cost.per.pub = round(mean(cost.per.pub), digits = 0))

kable(summary_mult_act.df, caption = "Cost Per Publication, Multiple PI vs Single PI Grants, by Activity")

```

Now, multiple PI grants have a higher cost per publication (less productive) than single PI grants.  This might be because they are higher cost grants (especially if they involve multiple PIs).  However, this does indicate that having more than one PI on a grant does not necessarily mean that they will produce more publications (the opposite is actually true).
